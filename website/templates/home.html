{% extends "base.html" %}
{% block title %}Home{% endblock %}
{% block content %} 

<div>
    <script type="text/javascript">
        window.onload = function() {
            const socket = io();
            let socketId = undefined;
            let progressBarValue = document.getElementById("progressBarValue")
            let progressBar = document.getElementById("progressBar")
            let table = document.getElementById("tableWithAppointments")

            socket.connect('https://localhost');
            socket.on("connect", function() {
                console.log("Connected")
                socketId = socket.id;
                console.log("SocketId: " + socketId)
                loadAppointments();
            })
            socket.on("update progress", function(percentage){
                console.log("Got percent: " + percentage)
                progressBarValue.style.width = percentage + "%"
            })

            function loadAppointments() {
                fetch("/load_appointments/" + socketId, {
                    method: "POST"
                }).then(response => {
                    setTimeout(function() {
                        showTable();
                        progressBarValue.style.width = "0%";
                    }, 0);
                });
            } 

            function showProgress() {
                progressBar.style.display = "flex"
                table.style.display = "none"
            } 

            function showTable() {
                progressBar.style.display = "none"
                table.style.display = "table"
            } 

            showProgress();
        }
    </script>    

    <h1 id="resource-name" class="text-center text-primary mt-2 mb-4">Nordic Watcher</h1>
    <p class="text-center">Here are the spots available for the next 10 days:</p>
    <div class="progress" id="progressBar">
        <div id="progressBarValue" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-label="Animated striped example" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100" style="width: 0%"></div>
    </div>      
    <table id="tableWithAppointments" class="table table-hover table-bordered">
        <caption id="date">
            <script>
                var date = new Date();
                const options = { month: 'short', day: 'numeric' };
                var currentDate = date.toLocaleDateString(undefined, options);
                var currentHours = ("0" + date.getHours()).slice(-2);
                var currentMinutes = ("0" + date.getMinutes()).slice(-2);
                var currentSeconds = ("0" + date.getSeconds()).slice(-2);
                var currentTime = currentHours + ':' + currentMinutes + ':' + currentSeconds;
                var lastUpdatedString = "Last updated: " + currentDate + ", " + currentTime;
                document.getElementById("date").innerHTML = lastUpdatedString;
            </script>    
        </caption>
        <thead class="table-dark">
          <tr>
            <th scope="col">Date</th>
            <th scope="col">Time</th>
            <th scope="col">â„– spots</th>
          </tr>
        </thead>
        {% for apt in appointments %} 
        <tbody>
          <tr>
            <td>{{ apt.date }}</td>
            <td>{{ apt.time }}</td>
            <td>{{ apt.numberOfSpots }}</td>
          </tr>
        </tbody>
        {% endfor %} 
    </table>
</div>
{% endblock %}
